<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Notificacion de consultas </title>

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/unicons.css">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/acordion.css">

  <!-- MAIN STYLE -->
  <link rel="stylesheet" href="css/tooplate-style.css">
</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-light">

    <div class="container">
      <a class="navbar-brand" href="/"><i class='uil uil-user'></i> Notificacion de consultas</a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        <span class="navbar-toggler-icon"></span>
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto" style="display: none;" id="headerTabs">
          <li class="nav-item">
            <a href="/query/my-queries" class="nav-link"><span data-hover="Consultas">Consultas</span></a>
          </li>
          <li class="nav-item">
            <a href="/info" class="nav-link"><span data-hover="Info">Info</span></a>
          </li>
        </ul>
        <ul class="navbar-nav ml-lg-auto">

          <button onclick="document.getElementById('id01').style.display='block'" style="width:auto;"
            id="botonLogin">Login</button>
          <h3 id="msgNombreLogueado" style="display:none;">Nombre</h1>
            <div name=" form1">
              <label class="logoutLblPos">
                <input name="submit2" type="submit" id="submit2" value="log out" onclick="logOut()">
              </label>
            </div>

        </ul>

      </div>
    </div>
  </nav>
  <!-- MODAL -->
  <div id="id01" class="modal" style="display:none;">

    <div class="modal-content animate">
      <div class="imgcontainer">
        <span onclick="document.getElementById('id01').style.display='none'" class="close"
          title="Close Modal">&times;</span>
        <img src="/images/mercadolibre.png" alt="Avatar" class="avatar">
      </div>

      <div class="container">
        <label for="uname"><b>Username</b></label>
        <input type="text" id="nameInput" placeholder="Enter Username" name="uname" required>

        <label for="psw"><b>Password</b></label>
        <input type="password" id="passwordInput" placeholder="Enter Password" name="psw" required>
        <label id="validCredential" style="color: red; display: none;"><b>Usuario/contrase√±a
            incorrectas.</b></label>
        <label id="validCredentialLastname" style="color: red; display: none;"><b>Su usuario no est√° habilitado para
            usar esta web.</b></label>

        <button onclick="iniciarSesion()">Iniciar sesi√≥n</button>
      </div>
    </div>
  </div>



  <!-- <script>
    localStorage.removeItem('token');
    localStorage.removeItem('nickname');
    localStorage.removeItem('email');
    localStorage.removeItem('name');
    localStorage.removeItem('lastName');


</script> -->



  <p>
    EN ESTA P√ÅGINA VAS A PODER AGENDAR CONSULTAS DE MERCADO LIBRE Y OBTENER UN AVISO CUANDO HAYA CAMBIOS O NUEVOS ITEMS
  </p>

  <!-- PARA IMPORTAR MAS DE UN HIJO -->
  <!-- <iframe src="included.html" onload="this.insertAdjacentHTML('afterend', (this.contentDocument.body||this.contentDocument).innerHTML);this.remove()"></iframe> -->

  <!-- FOOTER -->
  <iframe src="components/footer.html"
    onload="this.before((this.contentDocument.body||this.contentDocument).children[0]);this.remove()"></iframe>


  <script src="js/jquery-3.3.1.min.js"></script>
  <script>
    // Get the modal
    var modal = document.getElementById('id01');

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    function iniciarSesion() {
      console.log("üöÄ ~ file: inicioSesion.js ~ line 14 ~ iniciarSesion ~ modal", modal)

      modal = document.getElementById('id01')

      let params = JSON.stringify({
        username: document.getElementById('nameInput').value,
        password: document.getElementById('passwordInput').value,
      });

      const http = new XMLHttpRequest()
      http.open('POST', '/auth/login')
      // http.setRequestHeader('Authorization', 'Bearer 288abceb-0a1a-4095-9f79-89d57d4c0ba9')
      http.setRequestHeader('Accept', '*/*')
      http.setRequestHeader('Content-type', 'application/json')
      http.send(params) // Make sure to stringify
      http.onload = function () {
        if (http.status === 200) {
          let token = JSON.parse(http.responseText).token;
          let nickname = JSON.parse(http.responseText).nickname;
          let email = JSON.parse(http.responseText).email;
          let firstname = JSON.parse(http.responseText).firstName;
          let lastName = JSON.parse(http.responseText).lastName;

          localStorage.setItem('token', token);
          localStorage.setItem('nickname', nickname);
          localStorage.setItem('email', email);
          localStorage.setItem('name', firstname);
          localStorage.setItem('lastName', lastName);
          document.getElementById('validCredential').style.display = "None";
          modal.style.display = "none";
          procesarInicioSesion();
          // buscarCategorias();
          // buscarMisReservas()
        } else {
          document.getElementById('validCredential').style.display = "Block";
          document.getElementById('validCredentialLastname').style.display = "None";
        }

      }
    }

    function logOut() {
      console.log("EM :PGIASFD DESLOGUEAR")
      var token = localStorage.getItem('token');
      var email = localStorage.getItem('email');

      let params = JSON.stringify({
        email: email,
      });

      const http = new XMLHttpRequest()
      http.open('POST', '/auth/logout')
      http.setRequestHeader('Authorization', 'Bearer ' + token)
      http.setRequestHeader('Accept', '*/*')
      http.setRequestHeader('Content-type', 'application/json')
      http.send(params) // Make sure to stringify
      http.onload = function () {
        console.log("DEBERIA DESLOGUEAR")
        if (http.status === 200) {
          console.log("DIO 2020")
          localStorage.removeItem('token');
          localStorage.removeItem('nickname');
          localStorage.removeItem('email');
          localStorage.removeItem('name');
          localStorage.removeItem('lastName');
          procesarInicioSesion();
        } else {
          console.log("No pudo desloguear")
        }

      }
    }

    function procesarInicioSesion() {
      // localStorage.removeItem('token');
      // localStorage.removeItem('nickname');
      // localStorage.removeItem('email');
      // localStorage.removeItem('name');
      // localStorage.removeItem('lastName');
      var nickname = localStorage.getItem('nickname');
      console.log("üöÄ ~ file: inicioSesion.js ~ line 84 ~ procesarInicioSesion ~ nickname", nickname)
      if (nickname && nickname != 'undefined') {
        if (document.getElementById('msgNombreLogueado')) {
          document.getElementById('msgNombreLogueado').innerHTML = nickname;
          document.getElementById('msgNombreLogueado').style.display = "Block";
        }
        if (document.getElementById('msgNombreLogueado')) {
          document.getElementById('headerTabs').style.display = "Flex";
          document.getElementById('botonLogin').style.display = "None";
        }
      }
      window.locationf = "/index.html";
    }

    procesarInicioSesion();

  </script>


</body>

</html>