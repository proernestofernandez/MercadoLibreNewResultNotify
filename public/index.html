<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Notificacion de consultas </title>

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/unicons.css">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/acordion.css">

  <!-- MAIN STYLE -->
  <link rel="stylesheet" href="css/tooplate-style.css">


</head>

<body>

  <!-- MENU -->
  <nav class="navbar navbar-expand-sm navbar-light">
    <div class="container">
      <a class="navbar-brand" href="index.html"><i class='uil uil-user'></i> Notificacion de consultas</a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        <span class="navbar-toggler-icon"></span>
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item">
            <a href="#actividades" class="nav-link"><span data-hover="Actividades">Actividades</span></a>
          </li>
          <li class="nav-item">
            <a href="#reservas" class="nav-link"><span data-hover="Reservas">Reservas</span></a>
          </li>
        </ul>


      </div>
    </div>
  </nav>


  <!-- LOGIN -->
  <div>
    <object data="components/InicioSesion.html" style="height: 100%; width: 100%;"></object>
  </div>



  <!-- Ultimas ejecuciones -->
  <div>
    <object data="components/lastExcecutions.html" style="height: 100%; width: 100%;"></object>
  </div>

  <!-- FOOTER -->
  <object data="components/footer.html"></object>

  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/Headroom.js"></script>
  <script src="js/jQuery.headroom.js"></script>
  <script src="js/acordion.js"></script>

  <script>

    function actividades(actId) {
      var token = localStorage.getItem('token');
      var userId = localStorage.getItem('userId');

      var i = 0;
      var length = 6;
      const http = new XMLHttpRequest();
      (function loop(i, length) {
        if (i >= length) {
          return;
        }

        http.open('GET', 'https://api-agenda.nacionalclubsocial.uy/activitytime/?id=' + actId + '&dow=' + i + '&userId=' + userId)
        http.setRequestHeader('Authorization', 'Bearer ' + token)
        http.setRequestHeader('Accept', '*/*')
        http.setRequestHeader('Content-type', 'application/json')
        http.onreadystatechange = function () {
          if (http.readyState === XMLHttpRequest.DONE && http.status === 200) {
            var actividades = JSON.parse(http.responseText).description;
            for (const act of actividades) {
              divPanel = document.getElementById('panel' + actId).innerHTML +=
                " <div style='display: flex; width: 100%;border-bottom: solid;padding-top: 10px;'> " +
                " <div  style='width: 70%'> " +
                "<p>Dia " + act.dayoftheweek + "  -  " + act.name + "  Inicio:" + act.starttime + "  Fin:" + act.endtime + "</p>" +
                "</div>" +
                " <div  style='width: 30%; text-align: right'> " +
                "<button style='width: fit-content;margin:0px;padding:5px' onclick='reservarActividad(" + act.id + "," + act.dayoftheweek + ")'>Reservar</button>" +
                "</div>" +
                "</div>";
            }

            loop(i + 1, length);
          }
        }
        http.send();
      })(0, length);

    }


    function reservarActividad(idAct, dow) {
      var token = localStorage.getItem('token');
      var userId = localStorage.getItem('userId');
      var dowToday = new Date().getDay();
      var dowReservar = 0;
      if (dow - dowToday >= 0) {
        dowReservar = dow - dowToday;
      } else {
        dowReservar = 7 + (dow - dowToday);
      }
      let params = "{\"usr\":\"" + userId + "\",\"at\":\"" + idAct + "\",\"day\":\"" + dowReservar + "\",\"description\":\"\"}";
      const http = new XMLHttpRequest()
      http.open('POST', 'https://api-agenda.nacionalclubsocial.uy/reservation/')
      http.setRequestHeader('Authorization', 'Bearer ' + token)
      http.setRequestHeader('Accept', '*/*')
      http.setRequestHeader('Content-type', 'application/json')
      http.setRequestHeader('Content-type', 'text/plain')
      http.send(params) // Make sure to stringify
      http.onload = function () {
        console.log("RESERVO");
        alert("Se ha procesado la reserva correctamente");
        buscarMisReservas();
      }
    }

  </script>



</body>

</html>